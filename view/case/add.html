<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>step-manager</title>
		<link rel="stylesheet" href="../../component/pear/css/pear.css" />
	</head>
	<body class="pear-container">
		

		<div class="layui-row layui-col-space12">
			<div class="layui-col-md3">
				<div class="layui-card">
					<div class="layui-card-body">
						<div id="pageTreeContent" style="overflow: auto">
							<ul id="pageTree" class="dtree pageTree" data-id="9527"></ul>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-md9">
				<div class="layui-card">
					<div class="layui-card-body">
						<table id="step-table" lay-filter="step-table"></table>
					</div>
				</div>
			</div>
		</div>

		<script type="text/html" id="step-bar">
			<button class="pear-btn pear-btn-success pear-btn-sm" lay-event="debug"><i class="layui-icon layui-icon-play"></i></button>
		    <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="useful"><i class="layui-icon layui-icon-right"></i></button>
		</script>

		<script type="text/html" id="step-createTime">
			{{layui.util.toDateString(d.createTime, 'yyyy-MM-dd')}}
		</script>

		<!-- ä¸æ¨èï¼ˆå› ä¸ºå½“ select å‡ºç°åœ¨ table åº•éƒ¨æ—¶ï¼Œå¯èƒ½ä¼šæ’‘èµ·å¤šä½™é«˜åº¦ï¼‰ -->
		<template id="TPL-select-action">
			{{# var actions =  [{"name":"FindTarget-ã€Œæ‰¾åˆ°å…ƒç´ ã€","id":1},{"name":"FindAndClick-ã€Œæ‰¾åˆ°å…ƒç´ å¹¶ç‚¹å‡»ã€","id":2},{"name":"FindAndInputSth-ã€Œæ‰¾åˆ°å…ƒç´ å¹¶è¾“å…¥å†…å®¹ã€","id":3},{"name":"FindTargetAttribute-ã€Œæ‰¾åˆ°å…ƒç´ å¹¶è·å–å…ƒç´ å±æ€§ã€","id":4},{"name":"FindTargetText-ã€Œæ‰¾åˆ°å…ƒç´ å¹¶è·å–å…ƒç´ çš„æ–‡æœ¬å†…å®¹ã€","id":5},{"name":"FindTargetAndIteratorChildAttribute-ã€Œæ‰¾åˆ°å…ƒç´ ç»„å¹¶éå†å…ƒç´ ä¿¡æ¯ã€","id":6},{"name":"FindTargetAndIteratorChildText-ã€Œæ‰¾åˆ°å…ƒç´ ç»„å¹¶éå†å­èŠ‚ç‚¹çš„æ–‡æœ¬ä¿¡æ¯ã€","id":7},{"name":"MustText-ã€Œæ‰¾åˆ°æ–‡æœ¬ä¿¡æ¯ã€","id":8},{"name":"FindAndHover-ã€Œæ‰¾åˆ°å…ƒç´ å¹¶é”®é¼ æ ‡æ‚¬æµ®åœ¨å…ƒç´ ä¸Šé¢ã€","id":9}]; }}
			{{# var selected = d.actionId; }}
			<select name="actionId" lay-filter="select-demo">
			<option value="">select æ–¹å¼</option>
			{{# layui.each(actions, function(i, v){ }}
			
			{{#  if(selected === v.id){ }}
			<option selected value="{{= v.id }}">{{= v.name }}</option>
			{{#  } else { }}
				<option value="{{= v.id }}">{{= v.name }}</option>
			{{#  } }} 
		
			{{# }); }}
			</select> 
		</template>
	

		<script src="../../component/layui/layui.js"></script>
		<script src="../../component/pear/pear.js"></script>
		<script src="/router/router.js"></script>
		<script>
			layui.use(['table', 'form', 'jquery','common','toast','loading','dtree'], function() {
				let table = layui.table;
				let form = layui.form;
				let $ = layui.jquery;
				let toast = layui.toast
				let loading = layui.loading
				let common = layui.common;
				let dTree = layui.dtree;
				let dropdown = layui.dropdown;
				let caseIdFrom = getQueryVariable("caseId")


				let DTree = dTree.render({
					elem: "#pageTree",
					//data: data,
					initLevel: "2", //é»˜è®¤å±•å¼€å±‚çº§ä¸º1
					line: true, // æœ‰çº¿æ ‘
					ficon: ["1", "-1"], // è®¾å®šä¸€çº§å›¾æ ‡æ ·å¼ã€‚0è¡¨ç¤ºæ–¹å½¢åŠ å‡å›¾æ ‡ï¼Œ8è¡¨ç¤ºå°åœ†ç‚¹å›¾æ ‡
					icon: ["0", "2"], // è®¾å®šäºŒçº§å›¾æ ‡æ ·å¼ã€‚0è¡¨ç¤ºæ–‡ä»¶å¤¹å›¾æ ‡ï¼Œ5è¡¨ç¤ºå¶å­å›¾æ ‡
					method: 'post',
					url: PAGE_API_TREE,
					dataStyle:'layuiStyle',
					parseData: function(res){ //res å³ä¸ºåŸå§‹è¿”å›çš„æ•°æ®

						return {
							data: res.data.row //è§£ææ•°æ®åˆ—è¡¨
						};
					},
				});

				// ç»‘å®šèŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
				dTree.on("node(pageTree)", function(obj) {
					if (!obj.param.leaf) {
						let $div = obj.dom;
						DTree.clickSpread($div); //è°ƒç”¨å†…ç½®å‡½æ•°å±•å¼€èŠ‚ç‚¹
					} else {
						console.log(obj.param)
						table.reload("step-table",{
							where: {target_page : obj.param.nodeId}
						});
					}
				});

				let cols = [
					[
						{
							title: 'id',
							field: 'id',
							align: 'center',
							width: 10
						},
						{
							title: 'description',
							field: 'description',
							align: 'left',
							edit:  `text`,
							width: '36%'
						},
						{
							title: 'targetElementId',
							field: 'targetElementId',
							align: 'left',
							edit:  `number`,
							hide: true
						},
						{
							title: 'action',
							field: 'actionId',
							templet: '#TPL-select-action',
							align: 'left',
						},
						{
							title: 'targetPage',
							field: 'targetPage',
							align: 'left',
							edit:  `number`,
							hide: true
						},
						{
							title: 'æ“ä½œ',
							toolbar: '#step-bar',
							align: 'center',
							width: 130
						}
					]
				]

				table.render({
					elem: '#step-table',
					url: STEP_API_LIST,
					page: true,
					cols: cols,
					parseData: function(res){ //res å³ä¸ºåŸå§‹è¿”å›çš„æ•°æ®
						return {
							"code": res.code, //è§£ææ¥å£çŠ¶æ€
							"msg": res.message, //è§£ææç¤ºæ–‡æœ¬
							"count": res.data.total, //è§£ææ•°æ®é•¿åº¦
							"data": res.data.row //è§£ææ•°æ®åˆ—è¡¨
						};
					},
					skin: 'line',
					toolbar: '#step-toolbar',
					css: [
						// è®¾ç½®å•å…ƒæ ¼æ ·å¼
						'.layui-table-cell{height: 50px; line-height: 40px; overflow: visible;}',
						'.layui-table-cell .layui-colorpicker{width: 38px; height: 38px;}'
					].join('')
					,done: function(res, curr, count){
						// è·å–å½“å‰è¡Œæ•°æ®
						// table.getRowData = function(elem){
						// 	var index = $(elem).closest('tr').data('index');
						// 	return table.cache['test'][index] || {};
						// };
						// layui form select äº‹ä»¶
						form.on('select(select-demo)', function(obj){
							console.log(obj); // è·å–é€‰ä¸­é¡¹æ•°æ®
							
							// è·å–å½“å‰è¡Œæ•°æ®(å¦‚ id ç­‰å­—æ®µï¼Œä»¥ä½œä¸ºæ•°æ®ä¿®æ”¹çš„ç´¢å¼•)
							var data = table.getRowData(obj.elem);
							console.log(data);
						});
						

					}
				});

				table.on('tool(step-table)', function(obj) {
					if (obj.event === 'useful') {
						window.useful(obj);
					}else if (obj.event === 'debug') {
						window.debug(obj);
					}
				});



				form.on('submit(step-query)', function(data) {
					table.reload('step-table', {
						where: data.field
					})
					return false;
				});

				form.on('switch(step-enable)', function(obj) {
					layer.tips(this.value + ' ' + this.name + 'ï¼š' + obj.elem.checked, obj.othis);
				});

				window.debug = function(obj) {
					loading.Load(1,'ğŸ˜„  tep-debugging ...ğŸ˜„ ');
					postData(CASE_STEP_DEBUG, {step_id:obj.data.id, input : 'debug ' + obj.data.description})
							.then(data => {
								// console.log(data.data.R); // JSON data parsed by `data.json()` call
								let targetReturn = "";
								let classNameReturn = "";
								if (data.code == 200 || data.code == 0){
									if (data.data.R.target != null){
										targetReturn = data.data.R.target.Object.description
										classNameReturn = data.data.R.target.Object.className
									}
									let messageReturn = '<p>className : ' + classNameReturn +  '</p><p>target : ' + targetReturn + '</p><p>returned : ' + data.data.R.returned + '</p>';
									toast.success({title: 'debug success ','message': messageReturn, 'position': 'topRight'});
								}else {
									let msg = '<p>code : ' + data.code + '</p><p>error : ' + data.message
									toast.error({title: 'debug failed ','message': msg ,'position': 'topRight'});
								}
							})
							.catch((error) => {
								console.log(error)
								toast.error({title: 'debug failed ',message: error,position: 'topRight'});
							});
					loading.loadRemove(1000)
				};

				window.add = function() {

					let treeSelected = dTree.getNowParam('pageTree');
					if (typeof treeSelected.nodeId === "undefined" ){
						toast.warning({title:"warning",message:"éœ€è¦å…ˆé€‰ä¸­ä¸€ä¸ªé¡µé¢æ‰å¯ä»¥æ–°å»ºï¼",position: 'topRight'})
					}else {
						layer.open({
							type: 2,
							title: 'æ–°å¢',
							shade: 0.1,
							area: [common.isModile()?'100%':'500px', common.isModile()?'100%':'400px'],
							content: './add.html?page='+treeSelected.nodeId
						});
					}
				}


				window.useful = function(obj) {
					// useful æ·»åŠ æ­¥éª¤
					console.log(obj)
					postData(CASE_STEP_API_CREATE, {
						stepId : obj.data.id,
						caseId : caseIdFrom,
						description : obj.data.description,
						score : 99
					})
							.then(data => {
								if (data.code == 200 || data.code == 0){
									// parent.layer.close(parent.layer.getFrameIndex(window
									// 		.name)); //å…³é—­å½“å‰é¡µ
									toast.success({title: 'success','message': 'create case-step: ' + obj.data.id + '  success ', 'position': 'topRight'});
									parent.layui.table.reload("case_step-table");
								}else {
									toast.error({title: 'create failed ! ',message: 'code :' + data.code + ' ' +data.message,position: 'topRight'});
								}
							})
							.catch((error) => {
								console.log(error)
								toast.error({title: 'create failed !',message: error,position: 'topRight'});
							});

					return false;
				}
			})

		</script>
	</body>
</html>
